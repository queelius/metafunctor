<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/lunr/lunr.js"></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>elasticsearch-lm | metafunctor</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="ElasticSearch Query Fine-Tuning Training Data for Large Language Models">
    <meta name="generator" content="Hugo 0.139.3">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    
      <meta name="author" content = "Alex Towell">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]      
    }
  };
</script>
        
    
    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/ghprojects/elasticsearch-lm/">
    

    <meta property="og:url" content="http://localhost:1313/ghprojects/elasticsearch-lm/">
  <meta property="og:site_name" content="metafunctor">
  <meta property="og:title" content="elasticsearch-lm">
  <meta property="og:description" content="ElasticSearch Query Fine-Tuning Training Data for Large Language Models">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ghprojects">
    <meta property="article:published_time" content="2024-02-03T17:11:56+00:00">
    <meta property="article:modified_time" content="2024-02-03T17:11:56+00:00">
    <meta property="article:tag" content="GitHub">
    <meta property="article:tag" content="Project">

  <meta itemprop="name" content="elasticsearch-lm">
  <meta itemprop="description" content="ElasticSearch Query Fine-Tuning Training Data for Large Language Models">
  <meta itemprop="datePublished" content="2024-02-03T17:11:56+00:00">
  <meta itemprop="dateModified" content="2024-02-03T17:11:56+00:00">
  <meta itemprop="wordCount" content="1557">
  <meta itemprop="keywords" content="GitHub,Project">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="elasticsearch-lm">
  <meta name="twitter:description" content="ElasticSearch Query Fine-Tuning Training Data for Large Language Models">

	
  </head>

  <body class="ma0 avenir bg-near-white">

    

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        metafunctor
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/social/" title="Social page">
              Social
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About Me page">
              About Me
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/ghprojects/" title="GitHub Projects page">
              GitHub Projects
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="News page">
              News
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/probsets/" title="Problem Sets page">
              Problem Sets
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/projects/" title="Projects page">
              Projects
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/publications/" title="Publications page">
              Publications
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/research/" title="Research page">
              Research
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/search/" title="Search page">
              Search
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>


    <main class="pb7" role="main">
      
<section class="project-section" style="padding: 2rem; background-color: #f9f9f9;">
  <div class="container" style="max-width: 1200px; margin: 0 auto;">
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
      
      
      <div>
        
        <header style="margin-bottom: 2rem;">
          <h1 style="font-size: 2.5rem; font-weight: 700; color: #333;">elasticsearch-lm</h1>
          <p style="color: #555; font-size: 1.1rem; margin-bottom: 0.5rem;">
             | February 3, 2024 | <a href="mailto:" style="color: #007acc;"></a>
          </p>

          
          <div style="overflow: hidden;">
            
            <p style="font-size: 1.25rem; color: #666;"></p>
          </div>
        </header>

        
        
        <section style="margin-bottom: 1rem;">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            
            <a href="https://github.com/queelius/elasticsearch-lm" target="_blank" style="padding: 0.75rem 1.5rem; background-color: #007acc; color: white; border-radius: 5px; text-decoration: none; transition: background-color 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
              GitHub
            </a>
            
            
            <a href="https://twitter.com/intent/tweet?text=elasticsearch-lm&url=http%3a%2f%2flocalhost%3a1313%2fghprojects%2felasticsearch-lm%2f" target="_blank" style="padding: 0.75rem .75rem; background-color: #1DA1F2; color: white; border-radius: 5px; text-decoration: none; transition: background-color 0.3s ease;">
              <i class="fab fa-twitter"></i>
            </a>

            
            <a href="https://www.linkedin.com/sharing/share-offsite/?url=http%3a%2f%2flocalhost%3a1313%2fghprojects%2felasticsearch-lm%2f" target="_blank" style="padding: 0.75rem .75rem; background-color: #0077B5; color: white; border-radius: 5px; text-decoration: none; transition: background-color 0.3s ease;">
              <i class="fab fa-linkedin"></i>
            </a>

            
            <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fghprojects%2felasticsearch-lm%2f" target="_blank" style="padding: 0.75rem .75rem; background-color: #1877F2; color: white; border-radius: 5px; text-decoration: none; transition: background-color 0.3s ease;">
              <i class="fab fa-facebook"></i>
            </a>
          </div>
        </section>
        

        
        <section style="margin-bottom: 3rem;">
          <h2 style="font-size: 1.75rem; font-weight: 600; color: #007acc;">Project Description</h2>
          <p style="font-size: 1.1rem; color: #555; line-height: 1.8;">
            <h1 id="elasticsearch-lm">elasticsearch-lm</h1>
<p>ElasticSearch Query Fine-Tuning Training Data for Large Language Models
<a href="https://github.com/queelius/elasticsearch-lm">GitHub Link</a>
<strong>Stars</strong>: 14 | <strong>Forks</strong>: 2 | <strong>Open Issues</strong>: 0
<strong>Languages Used</strong>: Python, Shell</p>
<h2 id="readme">README</h2>
<h1 id="fine-tuning-language-models-for-api-query-generation">Fine-Tuning Language Models for API Query Generation</h1>
<h2 id="project-overview">Project Overview</h2>
<p>This project aims to fine-tune a smaller Large Language Model (LLM) for the specific task of translating natural language queries (NLQs) into structured API queries, with an initial focus on Elasticsearch&rsquo;s Query DSL. The motivation behind this effort is to significantly enhance the accessibility and usability of API endpoints, making them more intuitive for users by allowing interactions in natural language.</p>
<p>The concept extends beyond Elasticsearch, proposing a universal approach to interfacing with various APIs. By leveraging compact, efficient language models, we envision a future where sophisticated API interactions are democratized, enabling more natural and user-friendly application interfaces.</p>
<h2 id="motivation">Motivation</h2>
<p>While Large Language Models have demonstrated remarkable capabilities in understanding and generating natural language, their size and resource requirements often limit widespread deployment, especially in resource-constrained environments. This project explores the potential of smaller, optimized models to perform complex tasks—like generating accurate API queries from NLQs—while maintaining low latency, minimal memory footprint, and reduced power consumption. Such models can revolutionize API interactions across numerous platforms, making technology more accessible and intuitive for a broader user base.</p>
<h2 id="objective">Objective</h2>
<p>Fine-tune a small LLM, <a href="https://github.com/jzhang38/TinyLlama">TinyLlama</a>, to accurately translate NLQs into Elasticsearch JSON queries based on given Elasticsearch mappings. The project aims to showcase the efficiency and competency of the model at the task, with the objective of being able to place it in diverse environments, from serverless architectures to edge devices.</p>
<h2 id="prior-work">Prior Work</h2>
<p>This work is inspired by existing models that translate NLQs into SQL queries, like <a href="https://huggingface.co/motherduckdb/DuckDB-NSQL-7B-v0.1">duckdb-nsq</a>. We aim to build on this foundation by adapting the approach to the task of generating structured API queries, starting with Elasticsearch&rsquo;s Query DSL. The project also draws from research on fine-tuning language models for specific tasks, with a focus on optimizing model size and performance.</p>
<h2 id="synthetic-data-generation">Synthetic Data Generation</h2>
<p>The foundation of our fine-tuning process involves creating a rich dataset of Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html">mappings (schemas)</a>, along with corresponding NLQs (natural language queries), and their target Elasticsearch JSON queries. This synthetic data is designed to cover a wide range of query types and complexities, ensuring that the model is trained on diverse examples that reflect real-world use cases.</p>
<p>This section details our approach to synthetic data generation, ensuring a broad coverage of query types and complexities.</p>
<p>We actually generated our synthetic data by first sampling from GPT-4, and then using those results to prime an open-source
model, <a href="https://llama.meta.com/">llama2</a>, to generate more synthetic data that was based on the high-quality examples
provided by GPT-4. This was done to ensure that the synthetic data was of high quality and covered a wide range of query types and complexities without costing too much in terms of computation resources. See the <code>synthetic_data_generation</code> directory for more details.</p>
<h3 id="process">Process</h3>
<p>We use the very large and capable GPT-4 model to generate the synthetic data. The process involves three key steps:</p>
<ol>
<li><strong>Generate Elasticsearch Mappings</strong>: Create diverse mappings that represent different data domains, from e-commerce to public records.</li>
<li><strong>Generate NLQs</strong>: For each mapping, develop a variety of natural language queries that reflect potential user intents.</li>
<li><strong>Generate Corresponding JSON Queries</strong>: Construct accurate Elasticsearch queries for each NLQ, demonstrating the desired output for the model.</li>
</ol>
<h3 id="json-format-of-training-data">JSON Format of Training Data</h3>
<p>Each training example is a JSON object structured to contain all the necessary information for training the model to translate NLQs against mappings into the target Elasticsearch JSON queries.</p>
<p>This JSON format is designed for use in training machine learning models, specifically aimed at converting natural language queries into structured API queries when conditioned on Elasticsearch mappings. By documenting this JSON format, users and contributors can better understand how to create, extend, and utilize the synthetic dataset for training and testing purposes, ensuring that the data is correctly formatted and meaningful for the intended training tasks.</p>
<h4 id="structure">Structure</h4>
<p>The JSON object for each training example comprises the following key components:</p>
<ul>
<li>
<p><strong><code>domain</code></strong>: A string that identifies the specific domain or context of the example (e.g., &ldquo;Healthcare Appointments&rdquo;, &ldquo;Employee Attendance&rdquo;). This helps in categorizing and filtering examples based on their application area.</p>
</li>
<li>
<p><strong><code>mapping</code></strong>: An object representing the Elasticsearch index mapping. This defines the schema of the data that the NLQ and query pertain to, including field names and their data types.</p>
</li>
<li>
<p><strong><code>NLQs</code></strong>: An array of objects, each containing:</p>
<ul>
<li><strong><code>NLQ</code></strong>: A string representing a natural language query. This is the query that a user might input, seeking information from the Elasticsearch index.</li>
<li><strong><code>query</code></strong>: The Elasticsearch JSON query that corresponds to the <code>NLQ</code>. This object is structured according to the Elasticsearch Query DSL, representing the exact query that should be executed to satisfy the information need expressed in the <code>NLQ</code>.</li>
</ul>
</li>
</ul>
<h5 id="example">Example</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;domain&#34;</span>: <span style="color:#e6db74">&#34;Sample Domain&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;mapping&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;field1&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;field2&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;date&#34;</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;field3&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span> }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;NLQs&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;NLQ&#34;</span>: <span style="color:#e6db74">&#34;Example natural language query&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;bool&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;must&#34;</span>: [{ <span style="color:#f92672">&#34;match&#34;</span>: { <span style="color:#f92672">&#34;field1&#34;</span>: <span style="color:#e6db74">&#34;some value&#34;</span> } }],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;filter&#34;</span>: [{ <span style="color:#f92672">&#34;range&#34;</span>: { <span style="color:#f92672">&#34;field2&#34;</span>: { <span style="color:#f92672">&#34;gte&#34;</span>: <span style="color:#e6db74">&#34;2023-01-01&#34;</span> } } }]
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="inference-time-the-system-instruction">Inference Time: The System Instruction</h2>
<p>At inference time, users and developers are expected to use a <code>system instruction</code> that it is similar to the training data. The model will then generate a query that is similar to the <code>query</code> field in the training data. For example, in the above example, the system instruction is given by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;domain&#34;</span>: <span style="color:#e6db74">&#34;Sample Domain&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;mapping&#34;</span>: { 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;field1&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;field2&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;date&#34;</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;field3&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span> }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then, when the user asks the NLQ &ldquo;Example natural language query&rdquo;, the program will
make this the prompt to the LLM, and the model will generate a response that
it has been fine-tuned to predict according to our synthetic training data.</p>
<h4 id="in-context-learning">In-Context Learning</h4>
<p>There is also an opportunity for in-context learning, where the developers of the system can, given their special domain knowledge of their users and data, provide additional examples of NLQs and their corresponding queries.
However, since we are assuming computation resources are limited, adding to the context will generally slow down
the system. This is a tradeoff that the developers will have to make. Indeed, if resources are not that constrained, then
better results can be achieved by using a larger language model and optionally providing examples for in-context learning.</p>
<h3 id="challenges-and-solutions">Challenges and Solutions</h3>
<ul>
<li><strong>Variability and Complexity</strong>: Addressed by including a wide range of query scenarios and incorporating both basic and advanced Elasticsearch functionalities.</li>
<li><strong>Realism</strong>: Ensured by basing synthetic data on realistic use cases and varying the structure and complexity of mappings.</li>
</ul>
<h2 id="fine-tuning-process">Fine-Tuning Process</h2>
<p>This section outlines the steps taken to adapt the language model to our specific task, including model selection, training environment setup, and evaluation metrics.</p>
<h3 id="model-selection">Model Selection</h3>
<p>Criteria for choosing a suitable smaller LLM include performance, efficiency, and adaptability to the task of generating structured API queries. This suggests looking for a model that has been fine-tuned on instruction following tasks, and that has a small memory footprint. The primary model we are considering is <a href="https://github.com/jzhang38/TinyLlama">TinyLlama</a>, which is a 1.1 billion parameter model that has been fine-tuned on instruction following tasks.</p>
<h3 id="training-and-evaluation">Training and Evaluation</h3>
<h4 id="dataset-preparation">Dataset Preparation</h4>
<p>We split the synthetic data into training, validation, and test sets, following a standard ratio (e.g., 70% training, 15% validation, 15% test). This ensures that the model is trained on a diverse range of examples and evaluated on unseen data.</p>
<h4 id="evaluation-metrics">Evaluation Metrics</h4>
<p>Since we synthetically generated the data, there is no real data on which to evaluate the model. Hoewver, to make this problem more tractable, we consider the data in the test set as the ground truth. So, for the test set, we will take an additional step of generating more synthetic data for specifying the contents of the database for each mapping (domain). For each of these, we will have GPT-4 generate a Python script that populates the database with relevant values, and so we should be able to make these databases as large as we want without much time and effort.</p>
<p>We will then run the queries generated in the test set that correspond to each NLQ, by the model on the populated database, and then compare the search results from the model with the ground truth. In this way, even if the predicted query is different, as long as the search results are similiar (precision, recall, etc), we can consider the model to have performed well.</p>
<p>In information retrieval, the following metrics are commonly used:</p>
<ul>
<li><strong>Accuracy</strong>: The proportion of search results that are relevant to the user&rsquo;s information need, as represented by the NLQ.</li>
<li><strong>Precision</strong>: The proportion of relevant search results among all retrieved results.</li>
<li><strong>Recall</strong>: The proportion of relevant search results that are retrieved among all relevant results.</li>
<li><strong>Execution Success Rate</strong>: The percentage of queries that are successfully executed. (The query may be malformed or invalid, leading to execution failure.)</li>
</ul>
<h2 id="future-directions">Future Directions</h2>
<p>While the initial focus is on Elasticsearch, the methodology and findings from this project have broader implications. Future work will explore extending this approach to other APIs, further reducing model size without compromising performance, and investigating deployment strategies for real-time applications.</p>
<h2 id="contributing">Contributing</h2>
<p>We welcome contributions from the community, whether it&rsquo;s in the form of feedback, bug reports, or pull requests.</p>

          </p>
        </section>
      </div>

    
    


      
      <aside>
        
        
        
        <section style="margin-bottom: 1rem;">
          <h2 style="font-size: 1.5rem;">Related</h2>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            
            <a href="http://localhost:1313/projects/elasticsearch-lm/">elasticsearch-lm</a>
            
            <a href="http://localhost:1313/ghprojects/video-playlist-manager/">video-playlist-manager</a>
            
            <a href="http://localhost:1313/projects/video-playlist-manager/">video-playlist-manager</a>
            
            <a href="http://localhost:1313/ghprojects/taskd/">taskd</a>
            
            <a href="http://localhost:1313/projects/taskd/">taskd</a>
            
          </div>
        </section>
        

        
        
        <section style="margin-bottom: 1rem;">
          <h2 style="font-size: 1.5rem">Tags</h2>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            
            <a href="/tags/github" style="display: inline-block; padding: 0.5rem 1rem; background-color: #f0f0f0; border-radius: 20px; font-size: 1rem; text-decoration: none; color: #007acc; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
              GitHub
            </a>
            
            <a href="/tags/project" style="display: inline-block; padding: 0.5rem 1rem; background-color: #f0f0f0; border-radius: 20px; font-size: 1rem; text-decoration: none; color: #007acc; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
              project
            </a>
            
          </div>
        </section>
        
      </aside>

    </div>
  </div>

</section>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  metafunctor 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
